/* Created by Administrator on 2016/3/16.*/var mysql=require("./../node_modules/mysql");//登录注册//数据库封装函数function db(){//创建数据库连接    var mydb=mysql.createConnection({        host:"localhost",        port:"3306",        user:"root",        password:"root",        database:"xiangjiaProject"    });    return mydb;}//登录验证exports.mylogin=function(req,resp,next){    var username=req.query.username;    //console.log(username);    var password=req.query.password;    var mydata=db();    mydata.connect();    var sql="select * from t_user where username=? and pass=?";    var sqlArray=[];    sqlArray.push(username);    sqlArray.push(password);    mydata.query(sql,sqlArray,function(err,data){        resp.send(data);    });    mydata.end();}//登录session//var mysession1;exports.denglu=function(req,resp,next){    var username=req.query.name;    var password=req.query.password;    //console.log(username+password);    var mydata=db();    mydata.connect();    var sql="select username from t_user where username=? and pass=?";    var sqlArray=[];    sqlArray.push(username);    sqlArray.push(password);    mydata.query(sql,sqlArray,function(err,data){        if(data.length>=1){            mysession1=req.session.name;            req.session.name=username;            //resp.render("index",{name:username});            var url= req.session.address;            console.log(url);            resp.redirect("index.html");        }    });    mydata.end();}exports.isLogin=function(req,resp){    var x=req.query.x;    //console.log(x);    if(x==1){        if(req.session.name!=null&&req.session.name!=undefined){            resp.send(req.session.name);        }else{            //console.log(req.session.name);        }    }}exports.loginout=function(req,resp){    req.session.name=null;    resp.redirect("index.html");}//注册验证用户名exports.mysign=function(req,resp){    //console.log(req.body.signUsername);    var signUsername=req.body.signUsername;    var mydata=db();    mydata.connect();    mydata.query("SELECT username FROM t_user WHERE username=?",[signUsername],function(err,data){        //console.log(data);        resp.send(data);    });    mydata.end();}//点击注册时添加数据exports.myzhuce=function(req,resp){    var signUsername=req.body.signUsername;    var signPassword=req.body.signPassword;    var mydata=db();    mydata.connect();    var sql="insert into t_user values (?,?,?,?,?,?)";    var myarray=[];    myarray.push(null);    myarray.push(signUsername);    myarray.push(signPassword);    myarray.push(null);    myarray.push(null);    myarray.push(null);    mydata.query(sql,myarray,function(err,data){        //console.log(data);    });    mydata.end();}//个人中心/////公开化函数，用户登录var mydatabase;//数据库创建,连接function mydb(){    mydatabase=mysql.createConnection({        host:"localhost",        port:"3306",        user:"root",        password:"root",        database:"xiangjiaProject"    });    //数据库连接    mydatabase.connect();}//验证密码修改的时候，密码输入是否正确， exports.checkPwd=function(req,resp){    var checkPwd=req.query.pass;     if(req.session.name!=null&&req.session.name!=undefined){         var mysession1=req.session.name;     }     mydb();     mydatabase.query("select * from t_user where username=? and pass=?",[mysession1,checkPwd],function(err,data){            resp.send(data);    });     mydatabase.end(); };//更新个人信息到数据库exports.personInfoJoin=function(req,resp){    var realName=req.query.name;    var phone=req.query.mobilephone;    var Email=req.query.Email;    if(req.session.name!=null&&req.session.name!=undefined){        var mysession1=req.session.name;    }    mydb();//第三步:操作使用数据库    mydatabase.query("UPDATE  t_user  SET NAME=?,mobilephone=?,Email=?  WHERE username=?",[realName,phone,Email,mysession1],function(err,data){        resp.send(data);    });    mydatabase.end();}exports.updatePwd=function(req,resp){    var newPass=req.query.newPass;    //var myusername=123;//登陆之后用session传入的用户名    //var myusername=req.sesssion.username;    if(req.session.name!=null&&req.session.name!=undefined){        var mysession1=req.session.name;    }    mydb();//第三步:操作使用数据库    mydatabase.query("UPDATE t_user SET pass=? WHERE username=?",[newPass,mysession1],function(err,data){        console.log(data+"数据");        //console.log(err);        //if(data!=null&&data!=undefined){        //    console.log("修改")        //    resp.send("添加成功")        //}else{        //    resp.send("已存在")        //}        resp.send(data);    })    mydatabase.end();};//历史订单的dao层从订单详情获取的数据var sql="SELECT* FROM t_product JOIN t_cart ON pro_id=c_productId  where c_userId=?";exports.getDoneOrder=function(req,resp){    var userNow;//当前登录的账号    if(req.session.name!=null&&req.session.name!=undefined){        userNow=req.session.name;    }    var listname=req.query.DoneOrderList;    mydb();//第三步:操作使用数据库    mydatabase.query(sql,[userNow],function(err,data){        //console.log(data+"数据");        resp.send(data);    })    mydatabase.end();};exports.getListing=function(req,resp){    var listname=req.query.name;    mydatabase();    mydb.query("select * from (t_product join t_cart on pro_id=c_productId)",[],function(err,data){        resp.send(data);    });    mydb.end();}